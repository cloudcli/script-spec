# 运维自动化脚本规范


规范编写脚本可为未来持续维护打好坚实基础。本脚本规范从脚本编写、命名、基本信息注释等方面，规范各个领域脚本开发，以推动运维自动化的建设和良性维护。


## 脚本编写原则

-  可以命令行传入参数，但是在脚本执行过程中不允许再有输入要求
-  支持以传递参数或传文件名的参数传入方式（绝对路径）
-  任何功能的脚本建议有五个部分组成:输入检查、执行条件检查、动作执行、执行结果校验、临时文件/数据清理。
-  脚本不涉及跨系统、跨用户的调用，跨系统、跨用户调用通过自动化平台流程编排实现，以便账户安全管控。
脚本记录所有的动作日志，包括所执行的命令，执行响应码（响应码含义需在脚本中明确注释）、以及执行过程日志。


## 脚本命名规范


*  脚本文件命名由3个字段组成，分别为：操作对象分类、操作对象、操作描述。
    -  操作对象分类：网络类操作对象如SWITCH、F5，基础资源类操作对象如OS、DB、STROAGE、MW。内容需大写。
    -   操作对象：指操作对象具体类型，如OS分类下的AIX、Windows；网络设备如HWS5700、CICSO3750X 。内容需大写。
    -   操作动作描述：运维脚本具体操作内容，如install、start、port_up。内容需小写。
*  两个英文单词间用 “_” 来分隔；
*  脚本后缀视脚本类型，如“.sh”、“.py”、“.bat”


```
示例：
OS_WINDOWS_service_start.bat
MW_WEBLOGIC_restart.sh
```


## 脚本基本信息

在每个脚本开头增加脚本基本注释信息，内容包含：脚本文件名、运行软件/硬件环境、作者、脚本编码格式、日期、功能描述、时间窗口、输入参数、输出参数、特殊说明等。


```
示例：
###############################################
# 文件名  ：OS_WINDOWS_service_start.bat
# 运行环境：windows 2003
# 编码格式：GBK2312
# 作    者：XXX
# 日    期：XXXX年 XX月XX日
# 功    能：windows服务启动
#时间窗口：脚本执行时间窗口
# 输入参数：服务名称
# 输出参数：0（执行成功）、1（执行失败）
# 特殊说明：脚本部署、执行过程中，对目录、权限、参数传递等特殊事项描述。
###############################################
```


## 脚本编写规范

### 常量规范


常量的命名全部用大写，以大写“V"开头，使用"_"作为单词间的分隔符，单词使用全名称. 使用Public来声明变量。

示例：
Public Const MSG_EMPTY_ROW As String = "有空行存在"。




## 变量规范

变量名由数字和字母组成，名字由两个或三个单词组成（单词尽量不使用缩写），但通常不应多于三个。普通变量以 ”v_” 开头。

-  环境变量与常量
环境变量命名要前后统一，全部使用大写字母，不需加“v_”。变量引用全部以变量名加双引号引用，如”$DIRECTORY”，或“${DIRECTORY}”。
错误码使用大写，以”E_” 开头；
使用变量来代替脚本常量，并且在脚本中都是用这个变量。避免无含义字符或数字,数字可以使用常量，常量同样以“V_”开头所有字母大写，

```
示例：
E_NOTFOUND=75  #错误码
MAIL_DIRECTORY=/var/spool/mail/bozo  #环境变量
V_RETURN_CODE=22  #常量
```

- 全局变量
如需要使用全局变量，则在变量加前缀g，如g_WORK_DIR，在变量使用时，使用“{}”将其括起，如${VARIABLE}。

- 局部变量
局部变量是定义在一个函数中的变量，必须以local方式进行声明，使之只在本函数中作用有效，以免造成在函数中的命名与程序中变量重名。


```
示例：
function TestFunc()
{
    local i
    for((i=0;i<n;i++))
    do
        do something
    done
}
```

- 变量合并

当某些变量或配置项要组合起来才有意义时，如文件的路径和文件名称，将要组合的变量合并到一起赋值给一个新的变量，这样既方便之后的调用，也为以后修改提供了方便。


### 参数规范


参数命名全部使用小写，如果参数包括两个或两个以上的单词时，首单词字母小写，其他单词首字母大写，如stepName、stepDescription。


### 函数规范


-  函数定义时，在函数名前加上function保留字
-  函数以动宾词形式存储，且第二个单词首字母要大写，如updateConfig。同时要注意前后缀，如后缀为Max则为最大值，Min为最小值，前缀is为判断型函数，Get则为取值函数，这样有益于对函数的返回理解更清晰。
-  在使用单词缩写时，也使用第二个单词首字母大写，如getHtmlContent而并非getHTMLContent，这样有利于命名规则的统一。
-  每个函数控制在50－100行，超出行数建议分解为两个函数。
-  多次反复调用的程序代码封装成函数，使程序条例清晰化。
-  函数名不超过30个字符。
如果函数存在返回值，通过显式返回（在函数的每个分支在函数的每个分支都包含显式的return语句，并跟上返回值。）


### 临时文件命名规范

尽量减少临时文件引用，如果必须使用临时文件，使用脚本的pid作为后缀，并在脚本结束时清除临时文件。


### 注释规范


脚本注释准确简洁，能够充分表达代码实现的功能。


### 脚本格式规范

#### 空行、空格

空行是区分代码块与块的间隔。
-  在函数之间必须加上空行；
-  在函数内部，变量声明块和实现块（实现块指除变量声明外的其他代码）要使用空行来间隔；
实现块的内部，通过空行来标识一个功能段。

### 敏感信息处理
脚本源码包含的敏感内容，如 user/passwd, 特别是数据库、中间件相关的脚本，不在脚本中体现，而是以参数传递形式体现。自动化平台调用脚本时，将参数传递给脚本执行。


## 输入、输出规范

###  输入规范


####     输入注释


- 传入参数注释
- 输出结果注释
- 日志位置注释
- 执行用户注释


```
示例：
################################################
# 传入参数：N个                                                            #
# 第一个：功能                                                        #
# 第二个：功能                                          #
# ……                                                  #
#第N个                                                                            #
#输出结果:   描述格式                                  #
#日志位置：/tmp/log/aa.log                          #
#执行用户: root                                       #
################################################

```


#### 标准参数输入

由自动化平台调用过程中传参给脚本。如 AIX_oracle_asm_install  VIP  heart_ip


#### 文件输入

在命令行给定具体存放参数的文件名，参数在10个以上建议采用文件方式。文件名与脚本名称一致默认文件放置路径与脚本一致。

文件方式传参具体的格式为:变量名称=值 （没有引号，前面无空格，首字符开始），变量名可以重复，先后位置代表顺序，参数中不能有双引号，单引号之类的值


```
示例：
例如：
Disk1=hdisk0
Disk2=hdisk2
或者
Para1=a b c d e
Para2=3 4 5 6
```

通过该方式取过来的变量在脚本中增加双引号,自动化平台调用时，检查输入 （检查操作系统已用的关键字符/保留字，例如：< > | &   ），如果出现，暂停给出提示。


### 输出规范

#### 响应码输出

脚本exit输出来判断脚本执行结果，响应码输出含义如下：

    0：表示执行服务成功；
    1：表示执行服务失败；

如定义其他响应码，需在脚本头注释说明。
自动化平台根据输出结果，判断此操作是否成功（0即成功，非0即失败）。


#### 标准输出

脚本执行过程输出结果，并在脚本中注释说明相应格式、内容说明。脚本由自动化平台调度时，自动化平台记录并展现执行过程。

#### 标准文件输出

标准输出内容也可采用文件的方式，传递给自动化平台，具体文件名固定或者通过标准输出传出去自定（输出文件名定义在脚本注释中须有明确描述）。


#### 标准错误输出

脚本不能屏蔽标准出错，自动化调度平台负责记录标准错误的内容，该内容在响应码为非0的时候有效，否则无效 。


## 文件格式规范

如果在windows或cmd环境下编写Linux/Unix脚本，需将脚本保存为UNIX格式。否则，脚本文件上传到服务器后，会带有^M特殊字符，导致脚本执行错误。


## 存放路径规范

脚本由脚本库进行统一版本管控，由自动化平台统一下发执行。具体下发目录根据落地过程中，实际IT环境规划而定。

脚本下发目录要求标准、统一，以降低后期管理复杂度。

执行路径相关脚本采用相对路径方式，并在脚本头的基本信息中，对存放、执行路径有明确描述。


# 共享脚本库分类

## 金融行业通用类脚本

### 网络类

#### 配置变更

    网络端口启停
    防火墙策略开通申请
    VPN开通


#### 健康检查

#####  网络设备

    网络路由状态检查
    网络设备CPU利用率
    网络带宽利用率
    日志系统报错
    端口状态检查

#### 防火墙

    访问控制策略是否生效
    在线访问审计是否生效

#### IDS（入侵检测系统）

    旁路访问审计
    旁路攻击审计


#### IPS（入侵防御系统）

    在线攻击防御
    在线攻击审计

####  合规检查

版本及补丁检查


### 基础设施

#### 硬件


#####   配置变更

硬件日志检查
网卡状态
硬盘状态


##### 合规检查

RAID级别



####  存储

##### 配置变更

##### 健康检查

剩余容量检查

系统日志报错检查

##### 合规检查

RAID级别检查

热盘配备检查


####  云管理

#####  安装部署

##### 配置变更

    云资源配置调整
    虚拟机重启
    虚拟机关机
    虚拟机删除
    虚拟机热迁移
    虚拟机快照
    虚拟机供给

#####  健康检查

#####  合规检查

###  通用组件

####     操作系统
#####  安装部署
#####  配置变更
#####  健康检查
    系统dmesg报错检查
    系统错误日志检查
    文件系统使用率检查
    僵尸进程检查
    交换空间使用率检查
    最耗cpu进程检查
    最耗内存的进程检查
    主机网络负载率检查
    本地磁盘I/O检查
#####  合规检查
操作系统补丁检查
特权用户检查（检查id为为0的非root用户是否存在）
检查mail日志文件大小
关键进程检查（如检查NTP进程）
资源限制（规定不能将default全部设置成unlimited，这里只检查root用户的主要资源参数hard限额）
交换区（检查交换区大小）
检查密码有效期策略（检查/etc/login.defs文件中的PASS_MAX_DAYS参数及PASS_WARN_AGE参数，以检查密码最长使用期限和密码到期提醒时间设置是否合规）
检查密码强度策略（检查/etc/pam.d/system-auth文件中的minlen参数及minclass参数，以检查密码最小长度和新密码至少应包含几种字符类型是否合规。）
登陆策略（检查登录失败锁定策略）
服务安全（检查非必须服务是否禁用）
超时设置（检查系统的超时设置）
重启日期（检查系统运行时长）
防病毒配置检查

####  数据库
#####  安装部署
Oracle安装
MySQL安装
DB2安装
SQL Server安装
#####   配置变更
#####   健康检查
数据库运行状态检查
表空间使用率检查
SGA命中率检查
TopSQL检查
数据库锁检查
集群运行状态检查
#####  合规检查
数据库运行模式检查
数据库密码策略检查
用户权限检查（查看是否有过多、无效的用户。）
数据库备份检查
版本/补丁检查
####    中间件
#####  安装部署
Tomcat安装
Weblogic安装
Websphere安装
Nginx安装

#####   配置变更
#####  健康检查
实例运行状态
GC是否正常
连接池是否正常
中间件运行错误日志
集群运行状态检查

#####   合规检查
集群运行是否正常
JVM配置检查
连接池设置检查
版本/补丁检查

##    业务领域通用脚本
###  银行
###   保险
###   证券
####     总部

#####   每日维护

- 开市前准备
   应用启动
   状态检查
   CPU、内存、磁盘状态
   应用程序运行状态
   行情、交易登陆验证
   行情库情况

- 开市
   每一小时检查行情、交易、数据库等设备/程序运行状态

- 闭市
   应用程序关闭
   数据备份
   交易数据库备份


#####  非每日定期
-   交易日志数据备份
-   每周固定 - 服务器、路由器、防火墙重启
-   备份
    -   操作系统：系统配置文件、动态链接库、系统目录等
    -   数据库：
    -   冷备或者在线备份；
    -   每月全量备份；每周差异备份；每天增量备份
    -   应用程序：打包备份（程序变动前或定期）

####    营业部
#####  开市前准备

-  系统运行情况检查
-  数据初始化
    清空接口库
-  开启通信系统
    行情、报盘、银证转账等
-  应用系统启动

#####  开市间维护
    应用运行监控


#####  闭市后处理
-   应用系统停止
-   数据清算
-   数据备份

###  其他


##    企业内部脚本

#  共享脚本库使用规范
##   脚本存储规范
###  集中存储规范

脚本集中存储，利于行业、企业对自动化运维脚本集中管理。
-   共享脚本存储规范：行业、领域共享脚本存储路径请参照共享脚本库分类。
-   企业脚本存储规范：企业内部视企业IT环境定义脚本存储路径，可参照基础架构、网络、通用软件、应用管理维度分类。

###  版本管理
建立脚本集中管理库，运维或开发人员创建、修改的脚本上传至脚本库，脚本库拥有版本管理功能，自动生成版本号、修改时间、修改说明等信息。

###  脚本变更说明
脚本修改人员上传脚本过程中，填写详细修改功能、修改模块等内容。时间、上传人员、版本号等由脚本管理库自动生成。

##    脚本审核规范
脚本审核人员对脚本进行审核验证，脚本通过验证后才可对外发布，验证内容至少包括：
-   脚本执行审核：对脚本可执行性进行验证，确认脚本可执行，且执行结果与脚本描述一致。
-   脚本规范审核：对脚本注释率、编写规则等项目进行审核。
-   脚本设计审核：对脚本执行安全、全面性、适应新等设计进行审核。
-   高危指令审核：判断脚本中是否出现rm、kill等高危指令，并对高危指令进行重点提示。


审核通过的脚本，可对外发布；未审核通过脚本，通知相关提交人并给出未通过原因及改正建议。


##    脚本执行规范
###  时间窗口

脚本必须明确注释自身的可执行时间，自动化平台根据时间窗口定义，严格控制脚本执行时间，以适应金融行业对变更窗口要求。

###  同步/异步执行

脚本必须同步执行，不能存在异步的方式。

###  执行权限

-  脚本明确注明执行环境变量及用户权限。
-  脚本中不涉及任何账户信息，脚本所需变量、执行账户均在自动化平台统一控制实现。
-  脚本中切勿存在跨用户执行操作。跨用户操作应分解为两个脚本，由自动化平台调度实现。

# 自动化平台使用要求

##    脚本库要求
###  提交/查看/下载管理

脚本库提供提交、查看、下载管理功能。不同角色用户可提交、查看、下载相应脚本。

脚本提交时，脚本库提供脚本描述及信息记录功能，供提交者填写脚本描述、脚本改动内容，并且自动记录提交人、提交时间等信息。


###  审核管理

脚本提交后，脚本库需具备审核功能，由指定角色对脚本进行审核。

-   审核通过后脚本发布，可供其他角色查看、下载；
-   未审核通过，审核人给出未通过原因及建议，发送给脚本提交人。

审核通过后，审核人可补充描述信息，且系统自动记录审核人、审核时间等信息，供审计回溯。

###   版本管理

脚本审核通过后，系统自动生成版本信息，根据提交人描述、审核者补充描述内容等内容，自动生成版本描述信息，且将提交人、提交时间、审核人、审核时间等信息自动录入此版本信息。

###    代码扫描
系统提供自动化代码扫描功能。根据预定义代码规范对提交脚本进行代码扫描，并将扫描结果以报告形式呈现给审核者，提高脚本审核效率和质量。

###    角色、权限管理
脚本库拥有完善角色、权限划分。权限至少包含：上传、审核、查看/下载权限。

##    自动化平台要求

###    配置管理

自动化平台有完善配置管理功能。变更类操作完成后，自动更新对应配置项信息，使配置项可持续、自动更新，保证配置管理库与IT环境保持一致。

###  操作对象鉴权管理
自动化平台拥有操作对象（如OS、数据库）的密码、秘钥管理功能。
当鉴权方式为密码时，自动化平台需对密码进行加密。

###  操作流程管理
自动化平台支持可视化操作流程管理，管理员可以通过可视化方式，轻松编辑操作流程。

###  审核管理
自动化平台支持对操作流程审核管理，只有经过审核的操作流程才能够对外发布、执行。

###  权限管理
自动化平台拥有严格、细致的权限管理功能，至少提供：
-   流程设计权限：面向平台管理人员，对操作流程进行设计、编排；
-   流程审核权限：面向设计、运维管理人员，对操作流程进行审核、发布；
-   流程管理权限：面向运维管理人员，对发布后的流程进行执行赋权，指定角色拥有此流程执行权限（或者在特定的时间段拥有执行权限）。
-   流程执行权限：面向专业技术人员、服务支持人员（含部分运维外包人员），被赋权的用户可以在时间窗口内执行指定流程。
-   执行查看权限：面向流程相关人员。

###  时间窗口管理
面向金融行业管理要求，自动化平台拥有时间窗口管理功能，根据场景指定操作在规定时间窗口内/外执行。